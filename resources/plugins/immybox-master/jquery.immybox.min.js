!function(){var a=[].slice,b=function(a,b){return function(){return a.apply(b,arguments)}},c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};!function(d,e){var f,g,h,i;i="immybox",g={choices:[],maxResults:50,showArrow:!0,openOnClick:!0,filterFn:function(a){return function(b){return b.text.toLowerCase().indexOf(a.toLowerCase())>=0}},formatChoice:function(b,c){var d,e,f,g,h;return e=b.text.toLowerCase().indexOf(c.toLowerCase()),e>=0?(f=b.text.slice(e,e+c.length),h=b.text.split(f),d=h[0],g=2<=h.length?a.call(h,1):[],""+d+"<span class='highlight'>"+f+"</span>"+g.join(f)):b.text}},h=[],f=function(){function a(a,c){this.reposition=b(this.reposition,this),this.revert=b(this.revert,this),this.openResults=b(this.openResults,this),this.doSelection=b(this.doSelection,this),this.doQuery=b(this.doQuery,this);var e,f;e=this,this.element=d(a),this.element.addClass(i),this._defaults=g,this._name=i,this.options=d.extend({},g,c),this.choices=this.options.choices,this.selectedChoice=null,this.options.showArrow&&this.element.addClass(""+i+"_witharrow"),this.options.openOnClick&&this.element.on("click",this.openResults),this.selectChoiceByValue(this.element.val()),this.queryResultArea=d("<div class='"+i+"_results'></div>"),"function"==typeof(f=this.queryResultArea).scrollLock&&f.scrollLock(),this.queryResultAreaVisible=!1,this._val=this.element.val(),this.oldQuery=this._val,this.queryResultArea.on("click","li."+i+"_choice",function(){var a;a=d(this).data("value"),e.selectChoiceByValue(a),e.hideResults(),e._val=e.element.val(),e.element.focus()}),this.queryResultArea.on("mouseenter","li."+i+"_choice",function(){e.queryResultArea.find("li."+i+"_choice.active").removeClass("active"),d(this).addClass("active")}),this.element.on("keyup change search",this.doQuery),this.element.on("keydown",this.doSelection)}return a.prototype.doQuery=function(){var a;a=this.element.val(),this._val!==a&&(this._val=a,this.oldQuery=a,""===a?this.hideResults():this.insertFilteredChoiceElements(a))},a.prototype.doSelection=function(a){if(27===a.which&&(this.display(),this.hideResults()),this.queryResultAreaVisible)switch(a.which){case 9:this.selectHighlightedChoice();break;case 13:a.preventDefault(),this.selectHighlightedChoice();break;case 38:a.preventDefault(),this.highlightPreviousChoice(),this.scroll();break;case 40:a.preventDefault(),this.highlightNextChoice(),this.scroll()}else switch(a.which){case 40:a.preventDefault(),null!=this.selectedChoice?this.insertFilteredChoiceElements(this.oldQuery):this.insertFilteredChoiceElements("");break;case 9:this.revert()}},a.prototype.openResults=function(a){a.stopPropagation(),this.revertOtherInstances(),null!=this.selectedChoice?this.insertFilteredChoiceElements(this.oldQuery):this.insertFilteredChoiceElements("")},a.prototype.revert=function(){this.queryResultAreaVisible?(this.display(),this.hideResults()):""===this.element.val()&&this.selectChoiceByValue(null)},a.prototype.reposition=function(){this.queryResultAreaVisible&&this.positionResultsArea()},a.prototype.insertFilteredChoiceElements=function(a){var b,c,e,f,g,h,j,k=this;b=""===a?this.choices:this.choices.filter(this.options.filterFn(this.oldQuery)),j=b.slice(0,this.options.maxResults),c=this.options.formatChoice,h=!1,g=j.map(function(b){var e;return e=d("<li class='"+i+"_choice'></li>"),e.attr("data-value",b.value),e.html(c(b,a)),b===k.selectedChoice&&(h=!0,e.addClass("active")),e}),0===g.length?(e=d("<p class='"+i+"_noresults'>no matches</p>"),this.queryResultArea.empty().append(e)):(h||g[0].addClass("active"),f=d("<ul></ul>").append(g),this.queryResultArea.empty().append(f)),this.showResults()},a.prototype.scroll=function(){var a,b,c,d,e,f,g;f=this.queryResultArea.height(),g=this.queryResultArea.scrollTop(),e=g+f,a=this.getHighlightedChoice(),null!=a&&(c=a.outerHeight(),d=a.position().top+g,b=d+c,g>d&&this.queryResultArea.scrollTop(d),b>e&&this.queryResultArea.scrollTop(b-f))},a.prototype.positionResultsArea=function(){var a,b,c,f,g,h;b=this.element.offset(),a=this.element.outerHeight(),c=this.element.outerWidth(),g=this.queryResultArea.outerHeight(),f=b.top+a+g,h=d(e).height()+d(e).scrollTop(),this.queryResultArea.outerWidth(c),this.queryResultArea.css({left:b.left}),f>h?this.queryResultArea.css({top:b.top-g}):this.queryResultArea.css({top:b.top+a})},a.prototype.getHighlightedChoice=function(){var a;return a=this.queryResultArea.find("li."+i+"_choice.active"),1===a.length?a:null},a.prototype.highlightNextChoice=function(){var a,b;a=this.getHighlightedChoice(),null!=a&&(b=a.next("li."+i+"_choice"),1===b.length&&(a.removeClass("active"),b.addClass("active")))},a.prototype.highlightPreviousChoice=function(){var a,b;a=this.getHighlightedChoice(),null!=a&&(b=a.prev("li."+i+"_choice"),1===b.length&&(a.removeClass("active"),b.addClass("active")))},a.prototype.selectHighlightedChoice=function(){var a,b;a=this.getHighlightedChoice(),null!=a?(b=a.data("value"),this.selectChoiceByValue(b),this._val=this.element.val(),this.hideResults()):this.revert()},a.prototype.display=function(){null!=this.selectedChoice?(this.selectedChoice.text,this.element.val(this.selectedChoice.text)):this.element.val(""),this._val=this.element.val()},a.prototype.selectChoiceByValue=function(a){var b,c,d;d=this.getValue(),null!=a&&""!==a?(b=this.choices.filter(function(b){return b.value==a}),this.selectedChoice=null!=b[0]?b[0]:null):this.selectedChoice=null,c=this.getValue(),c!==d&&this.element.trigger("update",[c]),this.display()},a.prototype.revertOtherInstances=function(){var a,b,c;for(b=0,c=h.length;c>b;b++)a=h[b],a!==this&&a.revert()},a.prototype.publicMethods=["showResults","hideResults","getChoices","setChoices","getValue","setValue","destroy"],a.prototype.showResults=function(){d("body").append(this.queryResultArea),this.queryResultAreaVisible=!0,this.scroll(),this.positionResultsArea()},a.prototype.hideResults=function(){this.queryResultArea.detach(),this.queryResultAreaVisible=!1},a.prototype.getChoices=function(){return this.choices},a.prototype.setChoices=function(a){return this.choices=a,null!=this.selectedChoice&&this.selectChoiceByValue(this.selectedChoice.value),this.oldQuery="",a},a.prototype.getValue=function(){return null!=this.selectedChoice?this.selectedChoice.value:null},a.prototype.setValue=function(a){var b;return b=this.getValue(),b!==a?(this.selectChoiceByValue(a),this.oldQuery="",this.getValue()):b},a.prototype.destroy=function(){var a=this;this.element.off("keyup change search",this.doQuery),this.element.off("keydown",this.doSelection),this.options.openOnClick&&this.element.off("click",this.openResults),this.element.removeClass(i),this.queryResultArea.remove(),d.removeData(this.element[0],"plugin_"+i),h=h.filter(function(b){return b!==a})},a}(),d("html").on("click",function(){var a,b,c;for(b=0,c=h.length;c>b;b++)a=h[b],a.revert()}),d(e).on("resize scroll",function(){var a,b,c;for(b=0,c=h.length;c>b;b++)a=h[b],a.queryResultAreaVisible&&a.reposition()}),d.fn[i]=function(a){var b,e;return b=Array.prototype.slice.call(arguments,1),e=[],this.each(function(){var g,j,k;if(d.data(this,"plugin_"+i)){if(null!=a&&"string"==typeof a){if(k=d.data(this,"plugin_"+i),g=a,!(c.call(k.publicMethods,g)>=0))throw new Error(""+i+" has no method '"+g+"'");e.push(k[g].apply(k,b))}}else j=new f(this,a),h.push(j),e.push(d.data(this,"plugin_"+i,j))}),e}}(jQuery,window,document)}.call(this);